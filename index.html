<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>3D Universe</title>
  <style>
    body { margin:0; overflow:hidden; background:black; color:white; font-family:sans-serif; }
    #menu {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.85); padding:20px; border:1px solid white;
      text-align:center; z-index:10;
    }
    input { margin:10px 0; }
    #startBtn { padding:8px 20px; cursor:pointer; }
    canvas { display:block; }
  </style>
</head>
<body>
  <!-- Menu ch·ªçn file -->
  <div id="menu">
    <h2>üåå Ch·ªçn nh·∫°c & ·∫£nh h√†nh tinh</h2>
    <input type="file" id="audioInput" accept="audio/*,video/*"><br>
    <input type="file" id="imageInput" accept="image/*" multiple><br>
    <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
  </div>

  <canvas id="c"></canvas>
  <audio id="bgm" controls style="display:none"></audio>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const menu = document.getElementById("menu");
    const canvas = document.getElementById("c");
    const btn = document.getElementById("startBtn");
    const bgm = document.getElementById("bgm");

    btn.onclick = () => {
      const file = document.getElementById("audioInput").files[0];
      const imgs = document.getElementById("imageInput").files;

      if (!file || imgs.length === 0) { alert("‚ö†Ô∏è Ch·ªçn nh·∫°c + ·∫£nh tr∆∞·ªõc!"); return; }

      // g√°n nh·∫°c v√†o audio tag
      bgm.src = URL.createObjectURL(file);
      bgm.loop = true;
      bgm.play().catch(err => console.log("Audio blocked:", err));

      // ·∫©n menu
      menu.style.display = "none";

      // ch·∫°y 3D
      start3D(imgs);
    };

    function start3D(imgs) {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 2000);
      camera.position.set(0, 100, 300);

      const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      scene.add(new THREE.AmbientLight(0x404040, 2));
      const point = new THREE.PointLight(0xffffff, 2);
      point.position.set(200,200,200);
      scene.add(point);

      // n·ªÅn sao
      const starsGeo = new THREE.BufferGeometry();
      const starPos = [];
      for (let i=0; i<2000; i++){
        starPos.push((Math.random()-0.5)*2000);
        starPos.push((Math.random()-0.5)*2000);
        starPos.push((Math.random()-0.5)*2000);
      }
      starsGeo.setAttribute("position", new THREE.Float32BufferAttribute(starPos, 3));
      const starsMat = new THREE.PointsMaterial({color:0xffffff});
      scene.add(new THREE.Points(starsGeo, starsMat));

      // h√†nh tinh trung t√¢m
      const centerGeo = new THREE.SphereGeometry(40, 64, 64);
      const centerMat = new THREE.MeshStandardMaterial({ color:0x3399ff });
      const centerPlanet = new THREE.Mesh(centerGeo, centerMat);
      scene.add(centerPlanet);

      // load ·∫£nh h√†nh tinh
      const planets = [];
      [...imgs].forEach((img, i) => {
        const reader = new FileReader();
        reader.onload = e => {
          const tex = new THREE.TextureLoader().load(e.target.result);
          const geo = new THREE.SphereGeometry(15, 32, 32);
          const mat = new THREE.MeshStandardMaterial({ map: tex });
          const mesh = new THREE.Mesh(geo, mat);
          const group = new THREE.Group();
          group.add(mesh);
          mesh.position.x = 100 + i*40;
          scene.add(group);
          planets.push({ group, mesh, speed:0.01 + i*0.002 });
        };
        reader.readAsDataURL(img);
      });

      // animation
      function animate() {
        requestAnimationFrame(animate);
        centerPlanet.rotation.y += 0.003;
        planets.forEach(p => {
          p.group.rotation.y += p.speed;
          p.mesh.rotation.y += 0.01;
        });
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    }
  </script>
</body>
</html>
