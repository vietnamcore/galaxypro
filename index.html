<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Universe Upload</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; font-family: sans-serif; }
    #menu {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.95);
      z-index: 10;
      color: white;
    }
    #menu input { margin: 10px; }
    #startBtn {
      padding: 10px 20px;
      margin-top: 15px;
      font-size: 16px;
      cursor: pointer;
    }
    canvas { display: none; }
  </style>
</head>
<body>
  <!-- Menu chọn file -->
  <div id="menu">
    <h2>Upload files</h2>
    <label>Ảnh hành tinh: <input type="file" id="planetInput" accept="image/*"></label><br>
    <label>Ảnh xung quanh: <input type="file" id="imagesInput" accept="image/*" multiple></label><br>
    <label>Nhạc nền: <input type="file" id="audioInput" accept="audio/*"></label><br>
    <button id="startBtn">Start</button>
  </div>

  <!-- Canvas 3D -->
  <canvas id="threeCanvas"></canvas>

  <!-- Thư viện Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const menu = document.getElementById("menu");
    const canvas = document.getElementById("threeCanvas");
    const startBtn = document.getElementById("startBtn");

    let planetFile, imageFiles = [], audioFile;

    function fileToURL(file) {
      return URL.createObjectURL(file);
    }

    startBtn.addEventListener("click", () => {
      const planetInput = document.getElementById("planetInput").files[0];
      const imagesInput = document.getElementById("imagesInput").files;
      const audioInput = document.getElementById("audioInput").files[0];

      if (!planetInput || imagesInput.length === 0 || !audioInput) {
        alert("Bạn phải chọn đủ 1 ảnh hành tinh, ảnh xung quanh và 1 file nhạc!");
        return;
      }

      planetFile = fileToURL(planetInput);
      imageFiles = [];
      for (let i = 0; i < imagesInput.length; i++) {
        imageFiles.push(fileToURL(imagesInput[i]));
      }
      audioFile = fileToURL(audioInput);

      menu.style.display = "none";
      canvas.style.display = "block";

      init3D();
      playMusic();
    });

    function playMusic() {
      const audio = new Audio(audioFile);
      audio.loop = true;
      audio.play();
    }

    function init3D() {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
      camera.position.set(0, 30, 150);

      const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Planet
      const planetGeo = new THREE.SphereGeometry(20, 64, 64);
      const planetMat = new THREE.MeshStandardMaterial({ 
        map: new THREE.TextureLoader().load(planetFile)
      });
      const planet = new THREE.Mesh(planetGeo, planetMat);
      scene.add(planet);

      // Light
      const light = new THREE.PointLight(0xffffff, 2, 1000);
      light.position.set(100, 200, 300);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040, 2));

      // Stars
      const starGeo = new THREE.BufferGeometry();
      const starCount = 2000;
      const starPos = [];
      for (let i = 0; i < starCount; i++) {
        starPos.push((Math.random() - 0.5) * 2000);
        starPos.push((Math.random() - 0.5) * 2000);
        starPos.push((Math.random() - 0.5) * 2000);
      }
      starGeo.setAttribute("position", new THREE.Float32BufferAttribute(starPos, 3));
      const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 2 });
      const stars = new THREE.Points(starGeo, starMat);
      scene.add(stars);

      // Images orbit
      const loader = new THREE.TextureLoader();
      const sprites = [];
      for (let i = 0; i < imageFiles.length; i++) {
        const tex = loader.load(imageFiles[i]);
        const mat = new THREE.SpriteMaterial({ map: tex });
        const sprite = new THREE.Sprite(mat);
        sprite.scale.set(15, 15, 1);

        const radius = 80 + Math.random() * 50;
        const angle = Math.random() * Math.PI * 2;
        sprite.userData = { radius, angle, speed: 0.002 + Math.random() * 0.002 };

        sprite.position.set(
          Math.cos(angle) * radius,
          (Math.random() - 0.5) * 50,
          Math.sin(angle) * radius
        );

        scene.add(sprite);
        sprites.push(sprite);
      }

      // Animate
      function animate() {
        requestAnimationFrame(animate);

        planet.rotation.y += 0.002;
        sprites.forEach(s => {
          s.userData.angle += s.userData.speed;
          s.position.x = Math.cos(s.userData.angle) * s.userData.radius;
          s.position.z = Math.sin(s.userData.angle) * s.userData.radius;
        });

        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    }
  </script>
</body>
</html>
