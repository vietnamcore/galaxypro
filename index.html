<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Universe with Upload</title>
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; color: white; }
    #menu {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.9);
      z-index: 10;
    }
    #menu h1 { margin-bottom: 20px; }
    #menu input { margin: 10px; }
    #startBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    canvas { display: none; }
  </style>
</head>
<body>
  <!-- Menu chọn file -->
  <div id="menu">
    <h1>Upload Files</h1>
    <input type="file" id="planetInput" accept="image/*">
    <input type="file" id="imagesInput" accept="image/*" multiple>
    <input type="file" id="audioInput" accept="audio/*">
    <button id="startBtn">Start</button>
  </div>

  <!-- Canvas 3D -->
  <canvas id="threeCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  
  <script>
    const startBtn = document.getElementById("startBtn");
    const menu = document.getElementById("menu");
    const canvas = document.getElementById("threeCanvas");

    let planetTexture, imageFiles = [], audioFile;

    // Chuyển file thành URL
    function fileToURL(file) {
      return URL.createObjectURL(file);
    }

    startBtn.addEventListener("click", () => {
      const planetInput = document.getElementById("planetInput").files[0];
      const imagesInput = document.getElementById("imagesInput").files;
      audioFile = document.getElementById("audioInput").files[0];

      if (!planetInput || imagesInput.length === 0 || !audioFile) {
        alert("Vui lòng chọn đầy đủ ảnh hành tinh, ảnh xung quanh và nhạc!");
        return;
      }

      planetTexture = fileToURL(planetInput);
      for (let i = 0; i < imagesInput.length; i++) {
        imageFiles.push(fileToURL(imagesInput[i]));
      }

      menu.style.display = "none";
      canvas.style.display = "block";
      init3D();
      playMusic();
    });

    function playMusic() {
      const audio = new Audio(URL.createObjectURL(audioFile));
      audio.loop = true;
      audio.play();
    }

    function init3D() {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
      camera.position.set(0, 50, 200);

      const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Planet
      const planetGeo = new THREE.SphereGeometry(20, 64, 64);
      const planetMat = new THREE.MeshStandardMaterial({ 
        map: new THREE.TextureLoader().load(planetTexture)
      });
      const planet = new THREE.Mesh(planetGeo, planetMat);
      scene.add(planet);

      // Light
      const light = new THREE.PointLight(0xffffff, 2, 2000);
      light.position.set(100, 200, 300);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040, 2));

      // Stars
      const starGeo = new THREE.BufferGeometry();
      const starCount = 2000;
      const starPos = [];
      for (let i = 0; i < starCount; i++) {
        starPos.push((Math.random() - 0.5) * 2000);
        starPos.push((Math.random() - 0.5) * 2000);
        starPos.push((Math.random() - 0.5) * 2000);
      }
      starGeo.setAttribute("position", new THREE.Float32BufferAttribute(starPos, 3));
      const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 2 });
      const stars = new THREE.Points(starGeo, starMat);
      scene.add(stars);

      // Images orbit
      const loader = new THREE.TextureLoader();
      const imageMeshes = [];

      for (let i = 0; i < imageFiles.length; i++) {
        const tex = loader.load(imageFiles[i]);
        const mat = new THREE.SpriteMaterial({ map: tex });
        const sprite = new THREE.Sprite(mat);
        sprite.scale.set(20, 20, 1);

        const radius = 100 + Math.random() * 50;
        const angle = Math.random() * Math.PI * 2;
        sprite.userData = { radius, angle, speed: 0.002 + Math.random() * 0.002 };

        sprite.position.set(
          Math.cos(angle) * radius,
          (Math.random() - 0.5) * 50,
          Math.sin(angle) * radius
        );

        scene.add(sprite);
        imageMeshes.push(sprite);
      }

      // Animate
      function animate() {
        requestAnimationFrame(animate);

        planet.rotation.y += 0.002;
        imageMeshes.forEach(sprite => {
          sprite.userData.angle += sprite.userData.speed;
          sprite.position.x = Math.cos(sprite.userData.angle) * sprite.userData.radius;
          sprite.position.z = Math.sin(sprite.userData.angle) * sprite.userData.radius;
        });

        controls.update();
        renderer.render(scene, camera);
      }

      animate();
    }

    window.addEventListener("resize", () => {
      if (!canvas.style.display || canvas.style.display === "none") return;
      location.reload(); // reload để fix canvas khi đổi kích thước
    });
  </script>
</body>
</html>
