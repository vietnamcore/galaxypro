<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Universe Demo</title>
  <style>
    body { margin:0; overflow:hidden; background:black; color:white; font-family:sans-serif; }
    #menu {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(0,0,0,0.85); padding:20px; border:1px solid white;
      text-align:center; z-index:10;
    }
    input { margin:10px 0; }
    #startBtn { padding:10px 20px; cursor:pointer; }
    canvas { display:block; }
  </style>
</head>
<body>
  <!-- Menu ch·ªçn file -->
  <div id="menu">
    <h2>üåå Ch·ªçn nh·∫°c & ·∫£nh h√†nh tinh</h2>
    <input type="file" id="audioInput" accept="audio/*,video/*"><br>
    <input type="file" id="imageInput" accept="image/*" multiple><br>
    <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
  </div>

  <canvas id="c"></canvas>
  <audio id="bgm" controls style="display:none"></audio>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const menu = document.getElementById("menu");
    const canvas = document.getElementById("c");
    const btn = document.getElementById("startBtn");
    const bgm = document.getElementById("bgm");

    btn.onclick = () => {
      const file = document.getElementById("audioInput").files[0];
      const imgs = document.getElementById("imageInput").files;

      if (!file || imgs.length === 0) { alert("‚ö†Ô∏è Ch·ªçn nh·∫°c + √≠t nh·∫•t 1 ·∫£nh!"); return; }

      bgm.src = URL.createObjectURL(file);
      bgm.loop = true;
      bgm.play().catch(err => console.log("Audio blocked:", err));

      menu.style.display = "none";
      start3D(imgs);
    };

    function start3D(imgs) {
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 3000);
      camera.position.set(0, 0, 1500);

      const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);

      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      scene.add(new THREE.AmbientLight(0x888888));
      const point = new THREE.PointLight(0xffffff, 2);
      point.position.set(200,200,200);
      scene.add(point);

      // n·ªÅn sao
      const starsGeo = new THREE.BufferGeometry();
      const starPos = [];
      for (let i=0; i<3000; i++){
        starPos.push((Math.random()-0.5)*4000);
        starPos.push((Math.random()-0.5)*4000);
        starPos.push((Math.random()-0.5)*4000);
      }
      starsGeo.setAttribute("position", new THREE.Float32BufferAttribute(starPos, 3));
      const starsMat = new THREE.PointsMaterial({color:0xffffff, size:2});
      scene.add(new THREE.Points(starsGeo, starsMat));

      // h√†nh tinh trung t√¢m
      const centerGeo = new THREE.SphereGeometry(80, 64, 64);
      const centerMat = new THREE.MeshStandardMaterial({ color:0x3399ff, roughness:0.4, metalness:0.6 });
      const centerPlanet = new THREE.Mesh(centerGeo, centerMat);
      scene.add(centerPlanet);

      // load ·∫£nh l√†m h√†nh tinh nh·ªè
      const planets = [];
      [...imgs].forEach((img, i) => {
        const reader = new FileReader();
        reader.onload = e => {
          const tex = new THREE.TextureLoader().load(e.target.result);
          for (let j=0; j<8; j++){ // m·ªói ·∫£nh nh√¢n b·∫£n nhi·ªÅu h√†nh tinh
            const geo = new THREE.SphereGeometry(25, 32, 32);
            const mat = new THREE.MeshStandardMaterial({ map: tex });
            const mesh = new THREE.Mesh(geo, mat);
            const group = new THREE.Group();
            group.add(mesh);
            mesh.position.x = 300 + (i*50);
            scene.add(group);
            planets.push({ group, mesh, speed:0.002 + Math.random()*0.004 });
          }
        };
        reader.readAsDataURL(img);
      });

      // hi·ªáu ·ª©ng zoom intro
      let introFrame = 0;

      function animate() {
        requestAnimationFrame(animate);

        if (introFrame < 200) { // zoom t·ª´ xa l·∫°i g·∫ßn
          camera.position.z -= 5;
          introFrame++;
        }

        centerPlanet.rotation.y += 0.002;
        planets.forEach(p => {
          p.group.rotation.y += p.speed;
          p.mesh.rotation.y += 0.01;
        });

        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    }
  </script>
</body>
</html>
